name: 自动抓取优选CF IP并同步更新
on:
  schedule:
    - cron: '0 */3 * * *'  # 每3小时自动执行
  workflow_dispatch:  # 手动触发

jobs:
  ip-collect-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 拉取远程仓库完整代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # 关键修复：添加 undetected-chromedriver 依赖
      - name: 安装Python依赖库
        run: |
          python -m pip install --upgrade pip
          # 包含所有需要的库：基础爬虫+反爬驱动+随机UA
          pip install requests beautifulsoup4 fake_useragent undetected-chromedriver

      - name: 运行IP抓取脚本
        run: python collect_ips.py
        continue-on-error: false

      - name: 运行IP筛选脚本
        run: python ip_filter.py
        continue-on-error: false

      - name: 同步远程代码并处理冲突
        run: |
          git fetch origin main
          git merge origin/main -X ours --no-edit || true
          if [ $? -ne 0 ]; then
            git reset --hard origin/main
            git merge --no-ff -X ours HEAD --no-edit
          fi

      - name: 提交修改并推送
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          if git status | grep -q -E "ip.txt|ip2.txt"; then
            git add ip.txt ip2.txt
            git commit -m "自动更新：抓取最新优选CF IP"
            git push origin HEAD:main
            echo "IP更新成功！"
          else
            echo "无新IP更新，无需提交"
          fi

      - name: 输出文件状态
        run: |
          echo "=== ip.txt行数 ==="
          wc -l ip.txt || echo "ip.txt不存在"
          echo "=== ip2.txt行数 ==="
          wc -l ip2.txt || echo "ip2.txt不存在"
